<%
  # Custom component functions
  @state_colours = {
    'pending' => 'warning',
    'passed' => 'success',
    'failed' => 'danger',
    'pending (parent)' => 'secondary',
    'passed (parent)' => 'secondary',
    'failed (parent)' => 'secondary'
  }

  def state_text_badge(state, text)
    content_tag(:span, text, class: "badge badge-pill badge-#{@state_colours[state]}")
  end

  def state_with_children_badge(labware_data)
    state_with_children = labware_data[:state_with_children]
    state_text_badge(state_with_children, state_with_children.humanize)
  end

  def render_header
    content_tag(:tr) do
      content_tag(:th, 'Barcode') +
      content_tag(:th, 'Created') +
      content_tag(:th, 'State') +
      content_tag(:th, 'Updated')
    end
  end

  def render_row(labware_data)
    content_tag(:tr) do
      content_tag(:td, link_to("#{labware_data[:record].labware_barcode&.human}", url_for(labware_data[:record]))) +
        content_tag(:td, labware_data[:record].created_at&.strftime('%Y-%m-%d')) +
        content_tag(:td, state_with_children_badge(labware_data) ) +
        content_tag(:td, labware_data[:record].updated_at.strftime('%Y-%m-%d'))
    end
  end

  def render_table(show_labware_with_children)
    if @purpose.nil?
      grouped_data = []
    else
      grouped_data =
        @grouped[@purpose].select do |labware_data|
         labware_data[:record].has_children == show_labware_with_children
         end
    end

    content_tag(:table, class: 'table table-striped table-sm border', style: 'table-layout: fixed') do
      content_tag(:thead) { render_header } +
        content_tag(:tbody) do
          if grouped_data.empty?
            content_tag(:tr) { content_tag(:td, 'No labware found', colspan: 6, class: 'text-center text-muted') }
          else
            # list of labware, with a link to each
            grouped_data.map { |labware_data| render_row(labware_data) }.join.html_safe
          end
        end
    end
  end
%>

<%= content do %>
  <h1>Limber Pipeline Progress Overview <small class="text-muted"><br/>
  <%= @pipeline_group_name -%></small></h1>

  <!-- filters - reload the page with a new param -->

  <!-- Date selectors -->
  <div class="btn-group btn-group-sm mb-2" role="group" aria-label="Date selectors">
    <%
      @dates = {
        'All time' => Date.new(1970, 1, 1),
        'Last month' => Date.today.prev_month,
        'Last week' => Date.today.prev_week,
        'Yesterday' => Date.yesterday,
        'Today' => Date.today
      }
    %>
    <%=
      @dates.map do |label, date|
        link_to label, pipeline_work_in_progress_path(id: @pipeline_group_name, date: date), method: :get, class: "btn btn-secondary #{'active' if date == @from_date}"
      end.join.html_safe
    %>
  </div>

  <!-- two columns, left for the purposes, right for the labware list -->
  <div class="row">
    <div class="col-lg-3 col-md-4">
      <h3 class="text-center">Purposes</h3>

    <!-- purpose cards, showing counts of labware for each state -->
    <% @ordered_purpose_list.each do |purpose_name| %>
      <%= card title: "#{purpose_name} (#{@grouped[purpose_name].size})", css_class: 'stackable-card rounded-0 text-center' do %>

        <% @grouped_state_counts[purpose_name].each do |state_with_children, count| %>
          <%= state_text_badge(state_with_children, "#{state_with_children.humanize} #{count}") %>
        <% end %>

        <span class="float-right">
          <%= link_to ">", pipeline_work_in_progress_path(id: @pipeline_group_name, purpose: purpose_name, date: @from_date), class: "btn btn-sm btn-info" %>
        </span>
      <% end %>

      <!-- add arrow between the cards -->
      <% if purpose_name != @ordered_purpose_list.last %>
        <span class="icon icon-arrow_down-secondary d-block mx-auto my-2"></span>
      <% end %>

    <% end %>
    </div>

    <!-- labware lists -->
    <div class="col-lg-9 col-md-8">
      <h3><%= @purpose || 'Labware' %></h3>
      <%= render_table(false) %> <!-- show_labware_with_children = false -->

      <h5><%= @purpose || 'Labware' %> with Children</h5>
      <%= render_table(true) %> <!-- show_labware_with_children = true -->
    </div>
  </div>

<% end %>
