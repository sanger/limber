<% csv_rows_hash =  @plate.wells_in_columns.each_with_object({}) do |xp_well, csv_rows|
  next if xp_well.empty? || @ancestor_plate.blank?
  stock_plate = @ancestor_plate.stock_plate
  request_id = xp_well.aliquots.first&.request&.id
  # if we cannot get a request id from the well aliquot we cannot fetch any information
  next unless request_id.present?
  ancestor_well = @ancestor_plate.match_well_with_request(request_id)
  # if we cannot find the related ancestor well we cannot fetch information
  next unless ancestor_well.present?
  # TODO: why is this request singular, but in the hamilton file creation code it is an array?
  if xp_well.aliquots.first&.request&.options[:submit_for_sequencing]
    csv_rows[ancestor_well.location] = [
      stock_plate&.barcode&.to_s,
      ancestor_well.location,
      ancestor_well.latest_molarity&.value,
      ancestor_well.sanger_sample_id&.to_s,
      ancestor_well.supplier_name,
      ancestor_well.input_amount_available&.to_s,
      xp_well.aliquots.first&.request&.options[:input_amount_desired]&.to_f,
      @plate&.barcode&.to_s,
      xp_well.location,
      xp_well.latest_concentration&.value,
      'Y',
      xp_well.aliquots.first&.request&.options[:sub_pool]&.to_i,
      xp_well.aliquots.first&.request&.options[:coverage]&.to_i,
      xp_well.aliquots.first&.request&.options[:bait_library]&.to_s
    ]
  else
    csv_rows[ancestor_well.location] = [
      stock_plate&.barcode&.to_s,
      ancestor_well.location,
      ancestor_well.latest_molarity&.value,
      ancestor_well.sanger_sample_id&.to_s,
      ancestor_well.supplier_name,
      nil,
      nil,
      @plate&.barcode&.to_s,
      xp_well.location,
      nil,
      'N',
      nil,
      nil,
      nil
    ]
  end
end %>
<% well_keys = %w[A1 B1 C1 D1 E1 F1 G1 H1 A2 B2 C2 D2 E2 F2 G2 H2 A3 B3 C3 D3 E3 F3 G3 H3 A4 B4 C4 D4 E4 F4 G4 H4 A5 B5 C5 D5 E5 F5 G5 H5 A6 B6 C6 D6 E6 F6 G6 H6 A7 B7 C7 D7 E7 F7 G7 H7 A8 B8 C8 D8 E8 F8 G8 H8 A9 B9 C9 D9 E9 F9 G9 H9 A10 B10 C10 D10 E10 F10 G10 H10 A11 B11 C11 D11 E11 F11 G11 H11 A12 B12 C12 D12 E12 F12 G12 H12] %>
<% well_keys.each do |well_key| %>
<% if csv_rows_hash.key?(well_key) %>
<%= CSV.generate_line csv_rows_hash[well_key], row_sep: "" %>
<% end %>
<% end %>